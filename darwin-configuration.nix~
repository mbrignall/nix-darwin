{ config, pkgs, ... }:
let
  tex = (pkgs.texlive.combine {
    inherit (pkgs.texlive) scheme-small
      dvisvgm dvipng # for preview and export as html
      wrapfig amsmath ulem hyperref capt-of;
      #(setq org-latex-compiler "lualatex")
      #(setq org-preview-latex-default-process 'dvisvgm)
  });
in

{

  # List packages installed in system profile.
  # allow the unfree stuff
  nixpkgs.config.allowUnsupportedSystem = true;
  nixpkgs.config.allowUnfree = true;
  nix = {
    package = pkgs.nixFlakes;
    extraOptions = ''
      experimental-features = nix-command flakes
    '';
  };

  home-manager.useUserPackages = true;

  # System packages
  environment.systemPackages = with pkgs; [
    # Applications
    alacritty
    bat
    black
    cmake
    colima
    ditaa
    direnv
    docker
    docker-compose
    editorconfig-core-c
    fd
    gcc
    git
    gimp
    glib
    gnumake
    google-cloud-sdk
    nix-direnv
    html-tidy
    jq
    mark
    nixfmt
    nodejs
    nodePackages.bash-language-server
    nodePackages.eslint
    nodePackages.prettier
    nodePackages.js-beautify
    nodePackages_latest.pnpm
    nodePackages.pyright
    nodePackages.stylelint
    nodePackages_latest.ts-node
    nodePackages.typescript-language-server
    nodePackages.vscode-langservers-extracted
    nodePackages.vscode-html-languageserver-bin
    pandoc
    postgresql
    ruff
    rnix-lsp
    sbcl
    shellcheck
    shfmt
    sketchybar
    spotify
    syncthing
    tex
    tree-sitter
    realvnc-vnc-viewer
    vscode-extensions.github.copilot
    yamlfmt
    yaml-language-server
    yarn
    zsh
    zsh-powerlevel10k
    
    #fonts
    fira-mono
    font-awesome
    font-awesome_5
    material-design-icons
    noto-fonts
    noto-fonts-cjk
    noto-fonts-emoji
    terminus-nerdfont
    victor-mono
  ];

  fonts.fontDir.enable = true;
  
  fonts.fonts = [
    pkgs.dejavu_fonts
    pkgs.fira-code-nerdfont
    pkgs.nerdfonts
    pkgs.font-awesome_5
  ];

  
  # Auto upgrade nix package and the daemon service.eg
  services = {

    emacs = {
      enable = true;
      package = pkgs.emacs29-macport;
    };
    nix-daemon.enable = true;

    sketchybar = {
      enable = true;
      package = pkgs.sketchybar;
    };

    skhd = {
      enable = true;
      package = pkgs.skhd;
    };

    tailscale = {
      enable = true;
      package = pkgs.tailscale;
    };

    yabai = {
      enable = true;
      package = pkgs.yabai;
      extraConfig = "/Users/martin.brignall/.config/yabai/yabairc";
    };
  };

  # System State Version
  system = {
    stateVersion = 4; # Ensure this matches your setup
    activationScripts.extraActivation.text = ''
      softwareupdate --install-rosetta --agree-to-license
    '';

    defaults = {
      dock = {
        autohide = true;
        show-recents = true;
        launchanim = true;
        mouse-over-hilite-stack = true;
        orientation = "right";
        tilesize = 43;
        largesize = 64;
      };

      finder = { _FXShowPosixPathInTitle = false; };
    };

    keyboard = {
      enableKeyMapping = true;
      remapCapsLockToControl = true;
    };
  };
  programs.zsh.enable = true;

}
